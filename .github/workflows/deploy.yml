name: Deploy AldraScan Catalog to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.4'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build web release
        run: flutter build web --release --base-href "/aldrascan-docs/"

      - name: Copy product images to build
        run: |
          echo "üì¶ Copiando im√°genes de productos..."
          # Las im√°genes est√°n en la carpeta assets
          # El build de Flutter ya las incluye si est√°n en pubspec.yaml assets
          echo "‚úÖ Build listo"

      - name: Generate Apple PWA icons
        run: |
          pip install Pillow -q
          python3 - << 'EOF'
          from PIL import Image
          import os

          src = "assets/icons/logo_aldrascan.png"
          web_dir = "build/web/icons"
          os.makedirs(web_dir, exist_ok=True)

          img = Image.open(src).convert("RGBA")

          def make_apple_icon(size, out_path):
              bg = Image.new("RGBA", (size, size), (255, 255, 255, 255))
              pad = int(size * 0.15)
              inner = size - pad * 2
              logo = img.copy()
              logo.thumbnail((inner, inner), Image.LANCZOS)
              x = (size - logo.width) // 2
              y = (size - logo.height) // 2
              bg.paste(logo, (x, y), logo)
              bg.convert("RGB").save(out_path, "PNG")

          sizes = {
              "apple-touch-icon-57x57.png": 57,
              "apple-touch-icon-60x60.png": 60,
              "apple-touch-icon-72x72.png": 72,
              "apple-touch-icon-76x76.png": 76,
              "apple-touch-icon-114x114.png": 114,
              "apple-touch-icon-120x120.png": 120,
              "apple-touch-icon-144x144.png": 144,
              "apple-touch-icon-152x152.png": 152,
              "apple-touch-icon-167x167.png": 167,
              "apple-touch-icon-180x180.png": 180,
              "apple-touch-icon-1024x1024.png": 1024,
          }
          for name, size in sizes.items():
              make_apple_icon(size, f"{web_dir}/{name}")
          print("‚úÖ Iconos Apple generados")
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'build/web'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
